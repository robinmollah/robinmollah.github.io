<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-58579844-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-58579844-1');
</script>
<!-- End Google Analytics -->

  
  <title>Uploading extra large files to S3 | Robin Mollah | Software Engineer &amp; Tech Enthusiast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="In this article, I will be discussing 3 approaches we have followed to upload large files to S3.As requirements increased, we had to face some issues in different methods we have faced and finally cam">
<meta property="og:type" content="article">
<meta property="og:title" content="Uploading extra large files to S3">
<meta property="og:url" content="https://blog.robin.engineer/2021/12/Uploading-extra-large-files-to-S3/">
<meta property="og:site_name" content="Robin Mollah | Software Engineer &amp; Tech Enthusiast">
<meta property="og:description" content="In this article, I will be discussing 3 approaches we have followed to upload large files to S3.As requirements increased, we had to face some issues in different methods we have faced and finally cam">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.robin.engineer/css/images/banner.jpg">
<meta property="article:published_time" content="2021-12-25T19:52:14.000Z">
<meta property="article:modified_time" content="2024-05-22T12:34:52.031Z">
<meta property="article:author" content="Robin Mollah">
<meta property="article:tag" content="AWS">
<meta property="article:tag" content="S3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.robin.engineer/css/images/banner.jpg">
  <meta name="description" content="In this article, I will be discussing 3 approaches we have followed to upload large files to S3.As requirements increased, we had to face some issues in different methods we have faced and finally cam">
<meta property="og:type" content="article">
<meta property="og:title" content="Uploading extra large files to S3">
<meta property="og:url" content="https://blog.robin.engineer/2021/12/Uploading-extra-large-files-to-S3/">
<meta property="og:site_name" content="Robin Mollah | Software Engineer &amp; Tech Enthusiast">
<meta property="og:description" content="In this article, I will be discussing 3 approaches we have followed to upload large files to S3.As requirements increased, we had to face some issues in different methods we have faced and finally cam">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-12-25T19:52:14.000Z">
<meta property="article:modified_time" content="2024-05-22T12:34:52.031Z">
<meta property="article:author" content="Robin Mollah">
<meta property="article:tag" content="AWS">
<meta property="article:tag" content="S3">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Robin Mollah | Software Engineer & Tech Enthusiast" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="https://robin.engineer/favicon.ico">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Robin Mollah | Software Engineer &amp; Tech Enthusiast</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">It&#39;s been decade since I am in love with coding and technology to make a future that doesn&#39;t sound like a reality.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.robin.engineer"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Uploading-extra-large-files-to-S3" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/12/Uploading-extra-large-files-to-S3/" class="article-date">
  <time class="dt-published" datetime="2021-12-25T19:52:14.000Z" itemprop="datePublished">2021-12-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Uploading extra large files to S3
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>In this article, I will be discussing 3 approaches we have followed to upload large files to S3.<br>As requirements increased, we had to face some issues in different methods we have faced and finally came out with the highest possible<br>performance in S3.<br>We have tried the following methods</p>
<ul>
<li>Streaming through multer-s3</li>
<li>Single PUT Request</li>
<li>Single POST Request</li>
<li>Multipart Upload<span id="more"></span></li>
</ul>
<h2 id="Multer-S3"><a href="#Multer-S3" class="headerlink" title="Multer-S3"></a><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/multer-s3">Multer-S3</a></h2><p>This is the quickest way to implement the upload to S3. The file is streamed through an intermediary server provisioned by us.<br>Multer-S3 is a simple middleware that takes care of permission related stuffs and other managements required.</p>
<h3 id="Pros"><a href="#Pros" class="headerlink" title="Pros"></a>Pros</h3><ul>
<li>Fastest to implement</li>
</ul>
<p>[[Insert image explaining the architecture]]</p>
<h3 id="Cons"><a href="#Cons" class="headerlink" title="Cons"></a>Cons</h3><h4 id="Intermediary-server-bottlenecks-bandwidth"><a href="#Intermediary-server-bottlenecks-bandwidth" class="headerlink" title="Intermediary server bottlenecks bandwidth"></a>Intermediary server bottlenecks bandwidth</h4><p>Intermediary server needs to have a lot of upload and download speed. And eventually, the server is always a breaking point.<br>The upload speed can be severely affected when number of uploaders increase.</p>
<h4 id="No-considerable-file-size-limit-for-our-requirements"><a href="#No-considerable-file-size-limit-for-our-requirements" class="headerlink" title="No considerable file size limit [for our requirements]"></a>No considerable file size limit [for our requirements]</h4><h4 id="Cannot-a-resume-an-interrupted-upload"><a href="#Cannot-a-resume-an-interrupted-upload" class="headerlink" title="Cannot a resume an interrupted upload"></a>Cannot a resume an interrupted upload</h4><p>Upload can be interrupted for network issues. It needs to be started from the beginning when using Multer-S3.</p>
<h2 id="PUT-Request"><a href="#PUT-Request" class="headerlink" title="PUT Request"></a>PUT Request</h2><p>We will need to generate a signed URL from S3 and then upload the file to S3. So, you will need to have a backend server that will<br>contain a function to retrieve a signed URL to upload a file. You will be able to mention expiry time, content type and other for that URL.<br>In our case, we have deployed this function in AWS Lambda.</p>
<p>[[Insert image explaining the architecture]]</p>
<h3 id="Pros-1"><a href="#Pros-1" class="headerlink" title="Pros"></a>Pros</h3><h4 id="No-need-to-worry-about-the-intermediary-server"><a href="#No-need-to-worry-about-the-intermediary-server" class="headerlink" title="No need to worry about the intermediary server"></a>No need to worry about the intermediary server</h4><p>It directly uploads from browser to S3.</p>
<h3 id="Cons-1"><a href="#Cons-1" class="headerlink" title="Cons"></a>Cons</h3><h4 id="Cannot-resume-a-failed-upload"><a href="#Cannot-resume-a-failed-upload" class="headerlink" title="Cannot resume a failed upload"></a>Cannot resume a failed upload</h4><p>If upload is failed due to network issues, we have to start from the beginning.<br>Also, network needs to be stable for the duration of the upload. As the file size is long, the time period is also very long.</p>
<h4 id="File-size-limited-to-2-GB"><a href="#File-size-limited-to-2-GB" class="headerlink" title="File size limited to 2 GB"></a>File size limited to 2 GB</h4><h4 id="Browser-gets-stuck-when-uploading-large-files"><a href="#Browser-gets-stuck-when-uploading-large-files" class="headerlink" title="Browser gets stuck when uploading large files"></a>Browser gets stuck when uploading large files</h4><p>It sends data by XMLHttpRequest. So, the browser loads the whole file in memory before uploading it.</p>
<h2 id="POST-Request"><a href="#POST-Request" class="headerlink" title="POST Request"></a>POST Request</h2><p>The process of generating signed URL is more like the PUT Request. In a single POST request we can send upto 2 GB&#x2F;5 GB file.<br>Finally, we have used this method to upload the file to S3 in conjunction with multipart upload strategy.</p>
<h3 id="Pros-2"><a href="#Pros-2" class="headerlink" title="Pros"></a>Pros</h3><h4 id="Browser-don’t-get-stuck-when-uploading-large-files"><a href="#Browser-don’t-get-stuck-when-uploading-large-files" class="headerlink" title="Browser don’t get stuck when uploading large files"></a>Browser don’t get stuck when uploading large files</h4><p>Unlike PUT request using XMLHttpRequest(a javascript Object), we can use HTML Form method POST to upload the files. So,<br>the browser doesn’t get stuck.</p>
<h2 id="Multipart-Upload"><a href="#Multipart-Upload" class="headerlink" title="Multipart Upload"></a>Multipart Upload</h2><p>The multipart upload can utilize maximum bandwidth from client side by opening multiple connections to S3. The implementation is complexer than others.<br>You can check the <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/mpuoverview.html">official link</a> for more details.<br>In this blog, I am going to discuss the implementation of multipart upload strategy in brief.</p>
<p>We had to make some changes in the backend. We had to start multipart upload. It gives us a UPLOAD_ID.<br>Instead of generating one pre-signed URL, we had to generate a pre-signed URL for each part of the file.<br>Then we will need to send the pre-signed URL to the client. Each part will be uploaded using that link, directly to S3.<br>Finally, after all parts have been successfully uploaded, we will complete the multipart upload using the ETAGs of each part.</p>
<p>[[Insert image explaining the architecture]]</p>
<p>Known size related limitations of S3 Multipart Upload<br><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/qfacts.html">https://docs.aws.amazon.com/AmazonS3/latest/userguide/qfacts.html</a></p>
<h3 id="Pros-3"><a href="#Pros-3" class="headerlink" title="Pros"></a>Pros</h3><h4 id="No-need-to-worry-about-the-intermediary-server-1"><a href="#No-need-to-worry-about-the-intermediary-server-1" class="headerlink" title="No need to worry about the intermediary server"></a>No need to worry about the intermediary server</h4><h4 id="No-need-to-worry-about-the-file-size-upto-TB"><a href="#No-need-to-worry-about-the-file-size-upto-TB" class="headerlink" title="No need to worry about the file size [upto * TB]"></a>No need to worry about the file size [upto * TB]</h4><h4 id="Resumable-upload"><a href="#Resumable-upload" class="headerlink" title="Resumable upload"></a>Resumable upload</h4><p>If upload is interrupted due to network issues, we can resume the upload and upload specific.</p>
<h4 id="Utilise-all-bandwidth-from-client-side"><a href="#Utilise-all-bandwidth-from-client-side" class="headerlink" title="Utilise all bandwidth from client side"></a>Utilise all bandwidth from client side</h4><p>We will be able to create multiple connections to S3 at once. Creating more than 1500 connections at a time might create problem.<br>From my experiments, I would recommend using around <strong>15 connections</strong></p>
<h3 id="More-tunings"><a href="#More-tunings" class="headerlink" title="More tunings"></a>More tunings</h3><p>We had to find optimum CHUNK SIZE and simultaneous connection number. Also, we have used Transfer Acceleration for the upload and download.<br>The client side code was served by CloudFront.</p>
<p>I would like to mention that later on we have moved to GCS(Google Cloud Storage) because of the speed of download. GCS<br>download speed is almost 5 times faster than S3. GCS has a lot of advantages over S3 like Multi region, dual region and<br>specific regions. Also, depending on the interval of downloading files, there are 4 archive systems. Checkout this blog for more details.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.robin.engineer/2021/12/Uploading-extra-large-files-to-S3/" data-id="clwht41hr000yicq6bi06gjfp" data-title="Uploading extra large files to S3" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/" rel="tag">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/S3/" rel="tag">S3</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/02/How-I-add-a-new-skill-or-experience-in-Robin-Engineer/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          How I add a new skill or experience in Robin.Engineer
        
      </div>
    </a>
  
  
    <a href="/2021/08/AWS-Lambda-pros-and-cons/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">What you need to know about AWS Lambda before using it.</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Cloud-computing/">Cloud computing</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/" rel="tag">AWS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bangla/" rel="tag">Bangla</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bash/" rel="tag">Bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud-Computing/" rel="tag">Cloud Computing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud-Functions/" rel="tag">Cloud Functions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Comparison/" rel="tag">Comparison</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Compute-Engine/" rel="tag">Compute Engine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EC2/" rel="tag">EC2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Extra-Large-files/" rel="tag">Extra Large files</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GCP/" rel="tag">GCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GCS/" rel="tag">GCS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GKE/" rel="tag">GKE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ingress/" rel="tag">Ingress</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IntelliJ-IDEA/" rel="tag">IntelliJ IDEA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lambda/" rel="tag">Lambda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Optimisation/" rel="tag">Optimisation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pug/" rel="tag">Pug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/S3/" rel="tag">S3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSL/" rel="tag">SSL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Server/" rel="tag">Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Version-Control/" rel="tag">Version Control</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AWS/" style="font-size: 20px;">AWS</a> <a href="/tags/Bangla/" style="font-size: 10px;">Bangla</a> <a href="/tags/Bash/" style="font-size: 10px;">Bash</a> <a href="/tags/Cloud-Computing/" style="font-size: 15px;">Cloud Computing</a> <a href="/tags/Cloud-Functions/" style="font-size: 10px;">Cloud Functions</a> <a href="/tags/Comparison/" style="font-size: 10px;">Comparison</a> <a href="/tags/Compute-Engine/" style="font-size: 10px;">Compute Engine</a> <a href="/tags/DevOps/" style="font-size: 10px;">DevOps</a> <a href="/tags/EC2/" style="font-size: 10px;">EC2</a> <a href="/tags/Extra-Large-files/" style="font-size: 10px;">Extra Large files</a> <a href="/tags/GCP/" style="font-size: 10px;">GCP</a> <a href="/tags/GCS/" style="font-size: 10px;">GCS</a> <a href="/tags/GKE/" style="font-size: 10px;">GKE</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/Ingress/" style="font-size: 10px;">Ingress</a> <a href="/tags/IntelliJ-IDEA/" style="font-size: 10px;">IntelliJ IDEA</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Lambda/" style="font-size: 10px;">Lambda</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Optimisation/" style="font-size: 10px;">Optimisation</a> <a href="/tags/Pug/" style="font-size: 10px;">Pug</a> <a href="/tags/S3/" style="font-size: 10px;">S3</a> <a href="/tags/SSL/" style="font-size: 15px;">SSL</a> <a href="/tags/Server/" style="font-size: 10px;">Server</a> <a href="/tags/Version-Control/" style="font-size: 10px;">Version Control</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/12/Optimising-disk-usage-of-a-linux-server/">Optimising disk usage of a linux server</a>
          </li>
        
          <li>
            <a href="/2022/12/Nginx-essentials-commands-and-routes/">Nginx essential cheatsheet</a>
          </li>
        
          <li>
            <a href="/2022/11/Generating-SSL-certificate-using-certbot/">Generating Lets Encrypt SSL certificate using Certbot</a>
          </li>
        
          <li>
            <a href="/2022/11/Deploying-third-party-SSL-in-the-GKE/">Deploying third party SSL in the GKE</a>
          </li>
        
          <li>
            <a href="/2022/07/Maintaing-extra-large-files-with-Git-and-GCS/">Maintaining extra large binary files with Git and GCS</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 Robin Mollah<br>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>